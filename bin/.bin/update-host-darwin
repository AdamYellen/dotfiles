#!/bin/bash

# Update Homebrew
brew update -q

# script/install-vscode-extensions

# Normalize 1Password paths across MacOS and Linux
mkdir -p ~/.1password
ln -sf ~/Library/Group\ Containers/2BUA8C4S2C.com.1password/t/agent.sock ~/.1password/agent.sock
if command -v /opt/homebrew/bin/op >/dev/null
then
   # On MacOS Apple Silicon, Homebrew is installed under /opt/homebrew, make link to /usr/local
   # On MacOS Intel, Homebrew is already installed under /usr/local
   ln -sf /opt/homebrew/bin/op /usr/local/bin/op
fi

# MacOS tweaks
##################################################################

# Ensure auto-update is always enabled
defaults read /Library/Preferences/com.apple.commerce.plist AutoUpdate | grep -q true
if [ $? -ne 0 ]
then
   sudo defaults write /Library/Preferences/com.apple.commerce.plist AutoUpdate true
fi

# Decrease Dock auto-hide delay
defaults write com.apple.dock "autohide-delay" -float "0.05"

# Show hidden files in Finder
defaults write com.apple.finder "AppleShowAllFiles" -bool "true"

# Show path in Finder
defaults write com.apple.finder "ShowPathbar" -bool "true"

# Default to list view in Finder
defaults write com.apple.finder "FXPreferredViewStyle" -string "Nlsv"

# Default search scope to current folder in Finder
defaults write com.apple.finder "FXDefaultSearchScope" -string "SCcf"

# Show hard disks on Desktop
defaults write com.apple.finder "ShowHardDrivesOnDesktop" -bool "true"

# Show the Quit option in Finder
defaults write com.apple.finder "QuitMenuItem" -bool "true"

# Don't create .DS_Store files on network shares
defaults write com.apple.desktopservices DSDontWriteNetworkStores "true"

# Restart Finder
killall Finder

# Enable true hibernation mode if a laptop
/usr/sbin/ioreg -c AppleSmartBattery -r | awk '/BatteryInstalled/ {print $3}' | grep -q "Yes"
if [ $? -eq 0 ]
then
  pmset -g | grep hibernatemode | grep 25 -q
  if [ $? -ne 0 ]
  then
    sudo pmset -a hibernatemode 25
  fi
fi
